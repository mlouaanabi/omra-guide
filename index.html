<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="theme-color" content="#16a34a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Omra Guide">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="https://em-content.zobj.net/source/apple/391/kaaba_1f54b.png">
  <title>Gestion PÃ¨lerins Omra</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    * { -webkit-tap-highlight-color: transparent; }
    ::-webkit-scrollbar { display: none; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect, useCallback } = React;

    // Storage helper
    const storage = {
      get: (k) => { try { return JSON.parse(localStorage.getItem(k)); } catch(e) { return null; } },
      set: (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch(e) {} }
    };

    // Icons as components
    const Icon = ({name, size=20, className=""}) => {
      useEffect(() => { lucide.createIcons(); }, []);
      return <i data-lucide={name} className={className} style={{width:size,height:size}}></i>;
    };

    function App() {
      const [pelerins, setPelerins] = useState([]);
      const [view, setView] = useState('dashboard');
      const [searchTerm, setSearchTerm] = useState('');
      const [appelStatus, setAppelStatus] = useState({});
      const [importModal, setImportModal] = useState(false);
      const [editingId, setEditingId] = useState(null);
      const [villeChambres, setVilleChambres] = useState('medine');
      const [showFilters, setShowFilters] = useState(false);
      const [filters, setFilters] = useState({chambre:'',sexe:'',ageMin:'',ageMax:'',hotel:''});
      const [hotels, setHotels] = useState({medine:[],makkah:[]});
      const [hotelModal, setHotelModal] = useState(false);
      const [newHotel, setNewHotel] = useState({nom:'',ville:'medine'});
      const [guideNumber, setGuideNumber] = useState('');
      const [guideModal, setGuideModal] = useState(false);
      const [positionModal, setPositionModal] = useState(false);

      useEffect(() => {
        const p = storage.get('pelerins-data');
        if(p) setPelerins(p);
        const h = storage.get('hotels-data');
        if(h) setHotels(h);
        const g = storage.get('guide-number');
        if(g) setGuideNumber(g);
      }, []);

      useEffect(() => { lucide.createIcons(); });

      const saveData = (data) => { storage.set('pelerins-data', data); };
      const saveHotels = (data) => { storage.set('hotels-data', data); };
      const saveGuide = (num) => { storage.set('guide-number', num); };

      const addHotel = () => {
        if(!newHotel.nom.trim()) return;
        const u = {...hotels, [newHotel.ville]: [...hotels[newHotel.ville], newHotel.nom.trim()]};
        setHotels(u); saveHotels(u); setNewHotel({nom:'',ville:'medine'});
      };

      const delHotel = (v,n) => {
        const u = {...hotels, [v]: hotels[v].filter(x=>x!==n)};
        setHotels(u); saveHotels(u);
      };

      const handleFile = (file) => {
        if(!file) return;
        const name = file.name.toLowerCase();
        if(name.endsWith('.csv')) {
          Papa.parse(file, {header:true, skipEmptyLines:true, complete:(r)=>processData(r.data)});
        } else {
          const reader = new FileReader();
          reader.onload = (e) => {
            const wb = XLSX.read(new Uint8Array(e.target.result), {type:'array'});
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            processData(data);
          };
          reader.readAsArrayBuffer(file);
        }
      };

      const processData = (data) => {
        const norm = (s) => s ? s.toString().trim().toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"") : '';
        const imported = data.map(row => {
          const n = {}; Object.keys(row).forEach(k => { n[norm(k)] = row[k]; });
          return {
            id: Date.now() + Math.random(), nom: n['nom']||'', prenom: n['prenom']||'',
            sexe: n['sexe']?.charAt(0).toUpperCase()==='F'?'F':n['sexe']?.charAt(0).toUpperCase()==='M'?'M':'',
            numPasseport: n['passeport']||'', dateNaissance: n['date naissance']||n['naissance']||'',
            lienFamilial: n['lien']||n['lien familial']||'', nomFamille: n['famille']||'',
            commentaire: n['commentaire']||'', whatsapp: n['whatsapp']||n['telephone']||'',
            numSaoudien: n['saoudien']||'', contactUrgence: n['urgence']||'', nomContactUrgence: n['nom urgence']||'',
            chambreMedine: n['chambre medine']||n['medine']||'', typeChambreMedine: n['type medine']||'',
            chambreMakkah: n['chambre makkah']||n['makkah']||'', typeChambreMakkah: n['type makkah']||'',
            hotelMedine: n['hotel medine']||'', hotelMakkah: n['hotel makkah']||''
          };
        }).filter(p => p.nom && p.prenom);
        if(!imported.length) { alert('Aucune donnÃ©e'); return; }
        const np = [...pelerins, ...imported]; setPelerins(np); saveData(np);
        setImportModal(false); alert('âœ… ' + imported.length + ' importÃ©(s)');
      };

      const exportExcel = () => {
        const data = pelerins.map(p => ({
          Nom:p.nom, Prenom:p.prenom, Sexe:p.sexe==='M'?'Masculin':p.sexe==='F'?'FÃ©minin':'',
          Passeport:p.numPasseport, 'Date Naissance':p.dateNaissance, Famille:p.nomFamille,
          'Hotel Medine':p.hotelMedine, 'Chambre Medine':p.chambreMedine,
          'Hotel Makkah':p.hotelMakkah, 'Chambre Makkah':p.chambreMakkah,
          WhatsApp:p.whatsapp, Commentaire:p.commentaire
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Pelerins");
        XLSX.writeFile(wb, 'pelerins_omra.xlsx');
      };

      const exportWhatsApp = () => {
        const list = pelerins.filter(p=>p.whatsapp).map(p=>`${p.prenom} ${p.nom}: ${p.whatsapp}`).join('\n');
        if(!list) { alert('Aucun contact'); return; }
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([list], {type:'text/plain'}));
        a.download = 'contacts_whatsapp.txt'; a.click();
      };

      const openWA = (num) => { if(num) window.open('https://wa.me/'+num.replace(/\s/g,'').replace(/^0/,'33'), '_blank'); };

      const sendPosition = () => {
        if(!guideNumber) { setGuideModal(true); return; }
        const clean = guideNumber.replace(/\s/g,'').replace(/^0/,'33');
        if(navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            (pos) => {
              const {latitude, longitude} = pos.coords;
              const msg = encodeURIComponent('ğŸ“ Voici ma position:\nhttps://www.google.com/maps?q='+latitude+','+longitude);
              window.open('https://wa.me/'+clean+'?text='+msg, '_blank');
            },
            () => { window.open('https://wa.me/'+clean+'?text='+encodeURIComponent('ğŸ“ Je souhaite partager ma position'), '_blank'); }
          );
        }
      };

      const askPosition = (p) => {
        if(!p.whatsapp) return;
        const clean = p.whatsapp.replace(/\s/g,'').replace(/^0/,'33');
        const msg = encodeURIComponent('ğŸ•‹ Salam '+p.prenom+',\n\nğŸ“Œ Pouvez-vous m\'envoyer votre position SVP ?');
        window.open('https://wa.me/'+clean+'?text='+msg, '_blank');
      };

      const delPelerin = (id) => { if(confirm('Supprimer?')) { const u = pelerins.filter(p=>p.id!==id); setPelerins(u); saveData(u); } };

      const getAge = (d) => { if(!d) return null; const t=new Date(), b=new Date(d); let a=t.getFullYear()-b.getFullYear(); if(t.getMonth()<b.getMonth()||(t.getMonth()===b.getMonth()&&t.getDate()<b.getDate())) a--; return a; };

      const filtered = pelerins.filter(p => {
        const ms = !searchTerm || p.nom?.toLowerCase().includes(searchTerm.toLowerCase()) || p.prenom?.toLowerCase().includes(searchTerm.toLowerCase());
        const mc = !filters.chambre || p.chambreMedine?.includes(filters.chambre) || p.chambreMakkah?.includes(filters.chambre);
        const mx = !filters.sexe || p.sexe === filters.sexe;
        const age = getAge(p.dateNaissance);
        const mamin = !filters.ageMin || (age !== null && age >= parseInt(filters.ageMin));
        const mamax = !filters.ageMax || (age !== null && age <= parseInt(filters.ageMax));
        const mh = !filters.hotel || p.hotelMedine === filters.hotel || p.hotelMakkah === filters.hotel;
        return ms && mc && mx && mamin && mamax && mh;
      });

      const familles = [...new Set(pelerins.map(p=>p.nomFamille).filter(Boolean))];

      const getChambreStats = (v) => {
        const ch = {}; pelerins.forEach(p => {
          const num = v==='medine' ? p.chambreMedine : p.chambreMakkah;
          const type = v==='medine' ? p.typeChambreMedine : p.typeChambreMakkah;
          if(num) { if(!ch[num]) ch[num]={type,n:0}; ch[num].n++; }
        });
        let tp=0, to=0;
        Object.values(ch).forEach(c => { const cap = c.type==='Duo'?2:c.type==='Triple'?3:c.type==='Quadruple'?4:0; tp+=cap; to+=c.n; });
        return {ch:Object.keys(ch).length, pl:tp, oc:to, tx:tp>0?Math.round((to/tp)*100):0};
      };

      const stM = getChambreStats('medine'), stK = getChambreStats('makkah');
      const stats = {total:pelerins.length, fam:familles.length, h:pelerins.filter(p=>p.sexe==='M').length, f:pelerins.filter(p=>p.sexe==='F').length, wa:pelerins.filter(p=>p.whatsapp).length, sante:pelerins.filter(p=>p.commentaire).length};

      const Nav = ({label, v, emoji}) => <button onClick={()=>setView(v)} className={`flex-1 flex flex-col items-center py-2 ${view===v?'text-green-600 border-t-2 border-green-600':'text-gray-500'}`}><span className="text-lg">{emoji}</span><span className="text-xs">{label}</span></button>;

      const Stat = ({val, label, color}) => <div className={`${color} text-white rounded-xl p-4`}><div className="text-2xl font-bold">{val}</div><div className="text-white/80 text-xs">{label}</div></div>;

      return (
        <div className="min-h-screen bg-gray-100 pb-16">
          <div className="bg-gradient-to-r from-green-600 to-green-500 text-white px-4 py-4 sticky top-0 z-30">
            <div className="flex items-center gap-3">
              <span className="text-2xl">ğŸ•‹</span>
              <div><h1 className="text-lg font-bold">Gestion PÃ¨lerins Omra</h1><p className="text-green-100 text-xs">{pelerins.length} pÃ¨lerin(s)</p></div>
            </div>
          </div>

          <div className="p-4 space-y-4">
            {view === 'dashboard' && (
              <>
                <div className="grid grid-cols-2 gap-3">
                  <Stat val={stats.total} label="PÃ¨lerins" color="bg-blue-500" />
                  <Stat val={stats.fam} label="Familles" color="bg-purple-500" />
                  <Stat val={stats.h} label="Hommes â™‚" color="bg-sky-500" />
                  <Stat val={stats.f} label="Femmes â™€" color="bg-pink-500" />
                </div>

                <div className="bg-white rounded-xl p-4 shadow-sm">
                  <h3 className="font-bold mb-3 text-sm">ğŸ¨ Remplissage chambres</h3>
                  <div className="space-y-3">
                    <div><div className="flex justify-between text-sm mb-1"><span>MÃ©dine</span><span className="font-bold text-blue-600">{stM.tx}%</span></div><div className="w-full bg-gray-200 rounded-full h-2"><div className="bg-blue-500 h-2 rounded-full" style={{width:stM.tx+'%'}}></div></div></div>
                    <div><div className="flex justify-between text-sm mb-1"><span>Makkah</span><span className="font-bold text-green-600">{stK.tx}%</span></div><div className="w-full bg-gray-200 rounded-full h-2"><div className="bg-green-500 h-2 rounded-full" style={{width:stK.tx+'%'}}></div></div></div>
                  </div>
                </div>

                <div className="bg-white rounded-xl p-4 shadow-sm">
                  <div className="flex justify-between items-center mb-3"><h3 className="font-bold text-sm">ğŸ¢ HÃ´tels</h3><button onClick={()=>setHotelModal(true)} className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full">+ Ajouter</button></div>
                  <div className="grid grid-cols-2 gap-3 text-sm">
                    <div><p className="font-medium text-blue-600 mb-1">MÃ©dine</p>{hotels.medine.length ? hotels.medine.map(h=><div key={h} className="flex justify-between bg-blue-50 px-2 py-1 rounded mb-1"><span className="text-xs">{h}</span><button onClick={()=>delHotel('medine',h)} className="text-red-500 text-xs">Ã—</button></div>) : <p className="text-xs text-gray-400">Aucun</p>}</div>
                    <div><p className="font-medium text-green-600 mb-1">Makkah</p>{hotels.makkah.length ? hotels.makkah.map(h=><div key={h} className="flex justify-between bg-green-50 px-2 py-1 rounded mb-1"><span className="text-xs">{h}</span><button onClick={()=>delHotel('makkah',h)} className="text-red-500 text-xs">Ã—</button></div>) : <p className="text-xs text-gray-400">Aucun</p>}</div>
                  </div>
                </div>

                <div className="bg-white rounded-xl p-4 shadow-sm">
                  <h3 className="font-bold text-sm mb-3">âš¡ Actions rapides</h3>
                  <div className="grid grid-cols-3 gap-2">
                    <button onClick={()=>{setEditingId(null);setView('form');}} className="flex flex-col items-center p-3 bg-green-50 rounded-lg"><span className="text-xl">â•</span><span className="text-xs text-green-700">Ajouter</span></button>
                    <button onClick={()=>setImportModal(true)} className="flex flex-col items-center p-3 bg-purple-50 rounded-lg"><span className="text-xl">ğŸ“¥</span><span className="text-xs text-purple-700">Import</span></button>
                    <button onClick={exportExcel} className="flex flex-col items-center p-3 bg-blue-50 rounded-lg"><span className="text-xl">ğŸ“¤</span><span className="text-xs text-blue-700">Export</span></button>
                    <button onClick={exportWhatsApp} className="flex flex-col items-center p-3 bg-emerald-50 rounded-lg"><span className="text-xl">ğŸ“±</span><span className="text-xs text-emerald-700">Contacts</span></button>
                    <button onClick={sendPosition} className="flex flex-col items-center p-3 bg-red-50 rounded-lg"><span className="text-xl">ğŸ“</span><span className="text-xs text-red-700">Ma position</span></button>
                    <button onClick={()=>setPositionModal(true)} className="flex flex-col items-center p-3 bg-amber-50 rounded-lg"><span className="text-xl">ğŸ”</span><span className="text-xs text-amber-700">Localiser</span></button>
                  </div>
                </div>

                <div className="bg-white rounded-xl p-4 shadow-sm">
                  <div className="flex justify-between items-center"><h3 className="font-bold text-sm">ğŸ“± NumÃ©ro guide</h3><button onClick={()=>setGuideModal(true)} className="text-xs text-green-600">{guideNumber?'Modifier':'Configurer'}</button></div>
                  <p className="text-sm text-gray-600 mt-1">{guideNumber || 'Non configurÃ©'}</p>
                </div>
              </>
            )}

            {view === 'list' && (
              <>
                <div className="flex gap-2">
                  <input type="text" placeholder="ğŸ” Rechercher..." value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} className="flex-1 px-3 py-2 border rounded-xl text-sm" />
                  <button onClick={()=>{setEditingId(null);setView('form');}} className="bg-green-600 text-white px-4 rounded-xl text-xl">+</button>
                </div>
                <div className="space-y-2">
                  {filtered.map(p => {
                    const age = getAge(p.dateNaissance);
                    return (
                      <div key={p.id} className="bg-white rounded-xl p-3 shadow-sm">
                        <div className="flex items-center justify-between">
                          <div className="flex items-center gap-3">
                            <div className={`w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm ${p.sexe==='F'?'bg-pink-500':'bg-blue-500'}`}>{p.prenom?.[0]}{p.nom?.[0]}</div>
                            <div>
                              <div className="font-bold text-sm">{p.prenom} {p.nom} {age && <span className="text-xs font-normal text-gray-500">({age}ans)</span>}</div>
                              <div className="flex flex-wrap gap-1 mt-1">
                                {p.hotelMedine && <span className="text-xs bg-blue-100 text-blue-700 px-1 rounded">{p.hotelMedine}</span>}
                                {p.chambreMedine && <span className="text-xs bg-blue-50 text-blue-600 px-1 rounded">Ch.{p.chambreMedine}</span>}
                                {p.hotelMakkah && <span className="text-xs bg-green-100 text-green-700 px-1 rounded">{p.hotelMakkah}</span>}
                              </div>
                              {p.commentaire && <p className="text-xs text-orange-600 mt-1">âš ï¸ {p.commentaire}</p>}
                            </div>
                          </div>
                          <div className="flex gap-1">
                            {p.whatsapp && <button onClick={()=>openWA(p.whatsapp)} className="p-2 text-emerald-600">ğŸ“±</button>}
                            {p.whatsapp && <button onClick={()=>askPosition(p)} className="p-2 text-amber-600">ğŸ“</button>}
                            <button onClick={()=>{setEditingId(p.id);setView('form');}} className="p-2 text-blue-600">âœï¸</button>
                            <button onClick={()=>delPelerin(p.id)} className="p-2 text-red-600">ğŸ—‘ï¸</button>
                          </div>
                        </div>
                      </div>
                    );
                  })}
                  {!filtered.length && <div className="text-center py-10 text-gray-400">Aucun pÃ¨lerin</div>}
                </div>
              </>
            )}

            {view === 'form' && <Form p={editingId?pelerins.find(x=>x.id===editingId):null} hotels={hotels} onSave={(data)=>{const u=editingId?pelerins.map(x=>x.id===editingId?{...data,id:editingId}:x):[...pelerins,{...data,id:Date.now()}];setPelerins(u);saveData(u);setView('list');}} onCancel={()=>setView('list')} />}

            {view === 'appel' && (
              <>
                <div className="bg-white rounded-xl p-3 shadow-sm flex justify-between"><span className="font-bold">âœ… Appel</span><span><span className="text-green-600 font-bold">{Object.values(appelStatus).filter(Boolean).length}</span>/{pelerins.length}</span></div>
                {pelerins.map(p=><div key={p.id} onClick={()=>setAppelStatus(s=>({...s,[p.id]:!s[p.id]}))} className={`bg-white rounded-xl p-3 shadow-sm flex justify-between items-center ${appelStatus[p.id]?'border-2 border-green-500':''}`}><div className="flex items-center gap-3"><div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold ${appelStatus[p.id]?'bg-green-500 text-white':'bg-gray-200'}`}>{p.prenom?.[0]}{p.nom?.[0]}</div><span className="text-sm">{p.prenom} {p.nom}</span></div>{appelStatus[p.id]?<span className="text-green-600 text-xl">âœ“</span>:<span className="w-5 h-5 border-2 border-gray-300 rounded-full"></span>}</div>)}
                {pelerins.length>0 && <button onClick={()=>setAppelStatus({})} className="w-full bg-gray-600 text-white py-2 rounded-xl text-sm">RÃ©initialiser</button>}
              </>
            )}

            {view === 'familles' && (
              <>
                <h2 className="font-bold">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Familles ({familles.length})</h2>
                {familles.map(f=>{const m=pelerins.filter(p=>p.nomFamille===f);return<div key={f} className="bg-white rounded-xl shadow-sm overflow-hidden"><div className="bg-purple-600 text-white px-4 py-2"><span className="font-bold">Famille {f}</span><span className="text-purple-200 text-sm ml-2">({m.length})</span></div><div className="p-3 space-y-2">{m.map(x=><div key={x.id} className="flex items-center gap-2 bg-gray-50 p-2 rounded-lg"><div className="w-7 h-7 bg-purple-500 rounded-full flex items-center justify-center text-white text-xs">{x.prenom?.[0]}{x.nom?.[0]}</div><div><p className="text-sm font-medium">{x.prenom} {x.nom}</p>{x.lienFamilial&&<p className="text-xs text-gray-500">{x.lienFamilial}</p>}</div></div>)}</div></div>;})}
                {!familles.length && <div className="text-center py-10 text-gray-400">Aucune famille</div>}
              </>
            )}
          </div>

          {/* Bottom Navigation */}
          <div className="fixed bottom-0 left-0 right-0 bg-white border-t flex z-30">
            <Nav label="Accueil" v="dashboard" emoji="ğŸ " />
            <Nav label="Liste" v="list" emoji="ğŸ‘¥" />
            <Nav label="Appel" v="appel" emoji="âœ…" />
            <Nav label="Familles" v="familles" emoji="ğŸ‘¨â€ğŸ‘©â€ğŸ‘§" />
          </div>

          {/* Modals */}
          {importModal && <Modal onClose={()=>setImportModal(false)} title="ğŸ“¥ Importer"><label className="block w-full bg-green-600 text-white py-3 rounded-xl text-center text-sm">ğŸ“ SÃ©lectionner fichier<input type="file" accept=".csv,.xlsx,.xls" onChange={e=>{if(e.target.files[0])handleFile(e.target.files[0]);}} className="hidden" /></label><p className="text-center text-xs text-gray-500 mt-2">CSV ou Excel</p></Modal>}

          {hotelModal && <Modal onClose={()=>setHotelModal(false)} title="ğŸ¢ Ajouter hÃ´tel"><input placeholder="Nom de l'hÃ´tel" value={newHotel.nom} onChange={e=>setNewHotel({...newHotel,nom:e.target.value})} className="w-full border rounded-xl px-3 py-2 mb-3 text-sm" /><select value={newHotel.ville} onChange={e=>setNewHotel({...newHotel,ville:e.target.value})} className="w-full border rounded-xl px-3 py-2 mb-3 text-sm"><option value="medine">MÃ©dine</option><option value="makkah">Makkah</option></select><button onClick={()=>{addHotel();setHotelModal(false);}} className="w-full bg-green-600 text-white py-2 rounded-xl text-sm">Ajouter</button></Modal>}

          {guideModal && <Modal onClose={()=>setGuideModal(false)} title="ğŸ“± NumÃ©ro guide"><input placeholder="+33 6 12 34 56 78" value={guideNumber} onChange={e=>setGuideNumber(e.target.value)} className="w-full border rounded-xl px-3 py-2 mb-3 text-sm" /><button onClick={()=>{saveGuide(guideNumber);setGuideModal(false);}} className="w-full bg-green-600 text-white py-2 rounded-xl text-sm">Enregistrer</button></Modal>}

          {positionModal && <Modal onClose={()=>setPositionModal(false)} title="ğŸ“Œ Demander position"><div className="max-h-64 overflow-y-auto space-y-2">{pelerins.filter(p=>p.whatsapp).map(p=><button key={p.id} onClick={()=>{askPosition(p);setPositionModal(false);}} className="w-full flex items-center gap-3 p-2 bg-gray-50 rounded-lg text-left"><div className={`w-8 h-8 rounded-full flex items-center justify-center text-white text-xs ${p.sexe==='F'?'bg-pink-500':'bg-blue-500'}`}>{p.prenom?.[0]}{p.nom?.[0]}</div><span className="text-sm">{p.prenom} {p.nom}</span></button>)}</div>{!pelerins.filter(p=>p.whatsapp).length&&<p className="text-center text-gray-400 py-4 text-sm">Aucun contact</p>}</Modal>}
        </div>
      );
    }

    const Modal = ({children, onClose, title}) => <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onClick={onClose}><div className="bg-white rounded-2xl p-5 w-full max-w-sm" onClick={e=>e.stopPropagation()}><div className="flex justify-between items-center mb-4"><h3 className="font-bold">{title}</h3><button onClick={onClose} className="text-xl">Ã—</button></div>{children}</div></div>;

    const Form = ({p, hotels, onSave, onCancel}) => {
      const [f, setF] = useState({nom:p?.nom||'',prenom:p?.prenom||'',sexe:p?.sexe||'',numPasseport:p?.numPasseport||'',dateNaissance:p?.dateNaissance||'',lienFamilial:p?.lienFamilial||'',nomFamille:p?.nomFamille||'',commentaire:p?.commentaire||'',whatsapp:p?.whatsapp||'',numSaoudien:p?.numSaoudien||'',contactUrgence:p?.contactUrgence||'',nomContactUrgence:p?.nomContactUrgence||'',hotelMedine:p?.hotelMedine||'',chambreMedine:p?.chambreMedine||'',typeChambreMedine:p?.typeChambreMedine||'',hotelMakkah:p?.hotelMakkah||'',chambreMakkah:p?.chambreMakkah||'',typeChambreMakkah:p?.typeChambreMakkah||''});
      const up = (k,v) => setF(x=>({...x,[k]:v}));
      const save = () => { if(!f.nom||!f.prenom){alert('Nom et prÃ©nom requis');return;} onSave(f); };
      const I = ({k,ph,t='text'}) => <input type={t} placeholder={ph} value={f[k]} onChange={e=>up(k,e.target.value)} className="w-full border rounded-xl px-3 py-2 text-sm" />;
      return (
        <div className="bg-white rounded-xl p-4 shadow-sm">
          <h2 className="font-bold mb-4">{p?'âœï¸ Modifier':'â• Ajouter'}</h2>
          <div className="space-y-3">
            <div className="grid grid-cols-2 gap-2"><I k="nom" ph="Nom *" /><I k="prenom" ph="PrÃ©nom *" /></div>
            <div className="grid grid-cols-3 gap-2"><select value={f.sexe} onChange={e=>up('sexe',e.target.value)} className="border rounded-xl px-2 py-2 text-sm"><option value="">Sexe</option><option value="M">M</option><option value="F">F</option></select><I k="numPasseport" ph="Passeport" /><I k="dateNaissance" t="date" /></div>
            <div className="grid grid-cols-2 gap-2"><I k="nomFamille" ph="Famille" /><select value={f.lienFamilial} onChange={e=>up('lienFamilial',e.target.value)} className="border rounded-xl px-2 py-2 text-sm"><option value="">Lien</option><option>Ã‰poux</option><option>Ã‰pouse</option><option>PÃ¨re</option><option>MÃ¨re</option><option>Fils</option><option>Fille</option></select></div>
            <p className="font-bold text-xs pt-2">ğŸ¨ MÃ©dine</p>
            <div className="grid grid-cols-3 gap-2"><select value={f.hotelMedine} onChange={e=>up('hotelMedine',e.target.value)} className="border rounded-xl px-2 py-2 text-sm"><option value="">HÃ´tel</option>{hotels.medine.map(h=><option key={h}>{h}</option>)}</select><I k="chambreMedine" ph="NÂ° Ch." /><select value={f.typeChambreMedine} onChange={e=>up('typeChambreMedine',e.target.value)} className="border rounded-xl px-2 py-2 text-sm"><option value="">Type</option><option>Duo</option><option>Triple</option><option>Quadruple</option></select></div>
            <p className="font-bold text-xs pt-2">ğŸ•‹ Makkah</p>
            <div className="grid grid-cols-3 gap-2"><select value={f.hotelMakkah} onChange={e=>up('hotelMakkah',e.target.value)} className="border rounded-xl px-2 py-2 text-sm"><option value="">HÃ´tel</option>{hotels.makkah.map(h=><option key={h}>{h}</option>)}</select><I k="chambreMakkah" ph="NÂ° Ch." /><select value={f.typeChambreMakkah} onChange={e=>up('typeChambreMakkah',e.target.value)} className="border rounded-xl px-2 py-2 text-sm"><option value="">Type</option><option>Duo</option><option>Triple</option><option>Quadruple</option></select></div>
            <p className="font-bold text-xs pt-2">ğŸ“ Contacts</p>
            <div className="grid grid-cols-2 gap-2"><I k="whatsapp" ph="WhatsApp" /><I k="numSaoudien" ph="NÂ° Saoudien" /></div>
            <textarea placeholder="Commentaires santÃ©" value={f.commentaire} onChange={e=>up('commentaire',e.target.value)} className="w-full border rounded-xl px-3 py-2 text-sm" rows={2} />
          </div>
          <div className="flex gap-3 mt-4"><button onClick={onCancel} className="flex-1 border py-2 rounded-xl text-sm">Annuler</button><button onClick={save} className="flex-1 bg-green-600 text-white py-2 rounded-xl text-sm">ğŸ’¾ Enregistrer</button></div>
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
  <script>
    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js').catch(()=>{});
    }
  </script>
</body>
</html>
